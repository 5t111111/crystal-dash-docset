<!DOCTYPE html><html lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta charset="utf-8"/>
  <meta id="repository-name" content="github.com/crystal-lang/crystal"/>
  <link href="../css/style.css" rel="stylesheet" type="text/css"/>
  
  <a class="dashingAutolink" name="autolink-2224"></a><a class="dashAnchor" name="//apple_ref/cpp/Class/HTTP%3A%3AFormData%20-%20github.com%2Fcrystal-lang%2Fcrystal"></a><title>HTTP::FormData - github.com/crystal-lang/crystal</title>
</head>
<body>



<div id="main-content">
<h1 class="type-name">

  <span class="kind">module</span> HTTP::FormData

</h1>





  <h2>Overview</h2>

  <p>Contains utilities for parsing <code>multipart/form-data</code> messages, which are
commonly used for encoding HTML form data.</p>

<h3>Examples</h3>

<p>Commonly, you&#39;ll want to parse a from response from a HTTP request, and
process it. An example server which performs this task is shown below.</p>

<pre><code><span class="k">require</span> <span class="s">&#34;http&#34;</span>
<span class="k">require</span> <span class="s">&#34;tempfile&#34;</span>

server <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Server</span>.<span class="k">new</span>(<span class="n">8085</span>) <span class="k">do</span> <span class="o">|</span>context<span class="o">|</span>
  name <span class="o">=</span> <span class="n">nil</span>
  file <span class="o">=</span> <span class="n">nil</span>
  <span class="t">HTTP</span><span class="t">::</span><span class="t">FormData</span>.parse(context.request) <span class="k">do</span> <span class="o">|</span>part<span class="o">|</span>
    <span class="k">case</span> part.name
    <span class="k">when</span> <span class="s">&#34;name&#34;</span>
      name <span class="o">=</span> part.body.gets_to_end
    <span class="k">when</span> <span class="s">&#34;file&#34;</span>
      file <span class="o">=</span> <span class="t">Tempfile</span>.open(<span class="s">&#34;upload&#34;</span>) <span class="k">do</span> <span class="o">|</span>file<span class="o">|</span>
        <span class="t">IO</span>.copy(part.body, file)
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">unless</span> name &amp;&amp; file
    context.response.status_code <span class="o">=</span> <span class="n">400</span>
    <span class="k">next</span>
  <span class="k">end</span>

  context.response <span class="o">&lt;&lt;</span> file.path
<span class="k">end</span>

server.listen</code></pre>

<p>To test the server, use the curl command below.</p>

<pre><code></code></pre>

<p>Another common case is sending formdata to a server using HTTP::Client. Here
is an example showing how to upload a file to the server above in crystal.</p>

<pre><code><span class="k">require</span> <span class="s">&#34;http&#34;</span>

<span class="t">IO</span>.pipe <span class="k">do</span> <span class="o">|</span>reader, writer<span class="o">|</span>
  channel <span class="o">=</span> <span class="t">Channel</span>(<span class="t">String</span>).<span class="k">new</span>(<span class="n">1</span>)

  spawn <span class="k">do</span>
    <span class="t">HTTP</span><span class="t">::</span><span class="t">FormData</span>.build(writer) <span class="k">do</span> <span class="o">|</span>formdata<span class="o">|</span>
      channel.send(formdata.content_type)

      formdata.field(<span class="s">&#34;name&#34;</span>, <span class="s">&#34;foo&#34;</span>)
      <span class="t">File</span>.open(<span class="s">&#34;foo.png&#34;</span>) <span class="k">do</span> <span class="o">|</span>file<span class="o">|</span>
        metadata <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">FormData</span><span class="t">::</span><span class="t">FileMetadata</span>.<span class="k">new</span>(filename: <span class="s">&#34;foo.png&#34;</span>)
        headers <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Headers</span>{<span class="s">&#34;Content-Type&#34;</span> =&gt; <span class="s">&#34;image/png&#34;</span>}
        formdata.file(<span class="s">&#34;file&#34;</span>, file, metadata, headers)
      <span class="k">end</span>
    <span class="k">end</span>

    writer.close
  <span class="k">end</span>

  headers <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Headers</span>{<span class="s">&#34;Content-Type&#34;</span> =&gt; channel.receive}
  response <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Client</span>.post(<span class="s">&#34;http://localhost:8085/&#34;</span>, body: reader, headers: headers)

  puts <span class="s">&#34;Response code </span><span class="i">#{</span>response.status_code<span class="s"><span class="i">}</span>&#34;</span>
  puts <span class="s">&#34;File path: </span><span class="i">#{</span>response.body<span class="s"><span class="i">}</span>&#34;</span>
<span class="k">end</span></code></pre>














  <h2>Defined in:</h2>
  
    
      <a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata/builder.cr#L1" target="_blank">http/formdata/builder.cr</a>
    
    <br/>
  
    
      <a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata/parser.cr#L1" target="_blank">http/formdata/parser.cr</a>
    
    <br/>
  
    
      <a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata/part.cr#L1" target="_blank">http/formdata/part.cr</a>
    
    <br/>
  
    
      <a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata.cr#L78" target="_blank">http/formdata.cr</a>
    
    <br/>
  





  <h2>Class Method Summary</h2>
  <ul class="list-summary">
    
      <li class="entry-summary">
        <a href="#build%28response%3AHTTP%3A%3AServer%3A%3AResponse%2Cboundary%3DMultipart.generate_boundary%2C%26block%29-class-method" class="signature"><strong>.build</strong>(response : HTTP::Server::Response, boundary = <span class="t">Multipart</span>.generate_boundary, &amp;block)</a>
        
          <div class="summary"><p>Builds a multipart/form-data message, yielding a <code><a href="../HTTP/FormData/Builder.html">FormData::Builder</a></code> object to the block which writes to <em>response</em> using *boundary.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#build%28io%2Cboundary%3DMultipart.generate_boundary%2C%26block%29-class-method" class="signature"><strong>.build</strong>(io, boundary = <span class="t">Multipart</span>.generate_boundary, &amp;block)</a>
        
          <div class="summary"><p>Builds a multipart/form-data message, yielding a <code><a href="../HTTP/FormData/Builder.html">FormData::Builder</a></code> object to the block which writes to <em>io</em> using <em>boundary</em>.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#parse%28io%2Cboundary%2C%26block%29-class-method" class="signature"><strong>.parse</strong>(io, boundary, &amp;block)</a>
        
          <div class="summary"><p>Parses a multipart/form-data message, yielding a <code><a href="../HTTP/FormData/Parser.html">FormData::Parser</a></code>.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#parse%28request%3AHTTP%3A%3ARequest%2C%26block%29-class-method" class="signature"><strong>.parse</strong>(request : HTTP::Request, &amp;block)</a>
        
          <div class="summary"><p>Parses a multipart/form-data message, yielding a <code><a href="../HTTP/FormData/Parser.html">FormData::Parser</a></code>.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#parse_content_disposition%28content_disposition%29%3ATuple%28String%2CFileMetadata%29-class-method" class="signature"><strong>.parse_content_disposition</strong>(content_disposition) : Tuple(String, FileMetadata)</a>
        
          <div class="summary"><p>Parses a <code>Content-Disposition</code> header string into a field name and <code><a href="../HTTP/FormData/FileMetadata.html">FileMetadata</a></code>.</p></div>
        
      </li>
    
  </ul>







<div class="methods-inherited">
  
</div>


  <h2>Class Method Detail</h2>
  
    <div class="entry-detail" id="build(response:HTTP::Server::Response,boundary=Multipart.generate_boundary,&amp;block)-class-method">
      <a class="dashingAutolink" name="autolink-2219"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20self.build%28response%20%3A%20HTTP%3A%3AServer%3A%3AResponse%2C%20boundary%20%3D%20Multipart.generate_boundary%2C%20%26block%29"></a><div class="signature">
        
        def self.<strong>build</strong>(response : <a href="../HTTP/Server/Response.html">HTTP::Server::Response</a>, boundary = <span class="t">Multipart</span>.generate_boundary, &amp;block)

        
      </div>
      
        <div class="doc">
<p>Builds a multipart/form-data message, yielding a <code><a href="../HTTP/FormData/Builder.html">FormData::Builder</a></code>
object to the block which writes to <em>response</em> using *boundary.
Content-Type is set on <em>response</em> and <code><a href="../HTTP/FormData/Builder.html#finish-instance-method">Builder#finish</a></code> is called on the
builder when the block returns.</p>

<pre><code>io <span class="o">=</span> <span class="t">IO</span><span class="t">::</span><span class="t">Memory</span>.<span class="k">new</span>
response <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Server</span><span class="t">::</span><span class="t">Response</span>.<span class="k">new</span> io
<span class="t">HTTP</span><span class="t">::</span><span class="t">FormData</span>.build(response, <span class="s">&#34;boundary&#34;</span>) <span class="k">do</span> <span class="o">|</span>builder<span class="o">|</span>
  builder.field(<span class="s">&#34;foo&#34;</span>, <span class="s">&#34;bar&#34;</span>)
<span class="k">end</span>
response.close

response.headers[<span class="s">&#34;Content-Type&#34;</span>] <span class="c"># =&gt; &#34;multipart/form-data; boundary=\&#34;boundary\&#34;&#34;</span>
io.to_s                          <span class="c"># =&gt; &#34;HTTP/1.1 200 OK\r\nContent-Type: multipart/form-data; boundary=\&#34;boundary\&#34;\r\n ...</span></code></pre>

<p>See: <code><a href="../HTTP/FormData/Builder.html">FormData::Builder</a></code></p>
</div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata.cr#L206" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="build(io,boundary=Multipart.generate_boundary,&amp;block)-class-method">
      <a class="dashingAutolink" name="autolink-2220"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20self.build%28io%2C%20boundary%20%3D%20Multipart.generate_boundary%2C%20%26block%29"></a><div class="signature">
        
        def self.<strong>build</strong>(io, boundary = <span class="t">Multipart</span>.generate_boundary, &amp;block)

        
      </div>
      
        <div class="doc">
<p>Builds a multipart/form-data message, yielding a <code><a href="../HTTP/FormData/Builder.html">FormData::Builder</a></code>
object to the block which writes to <em>io</em> using <em>boundary</em>.
<code><a href="../HTTP/FormData/Builder.html#finish-instance-method">Builder#finish</a></code> is called on the builder when the block returns.</p>

<pre><code>io <span class="o">=</span> <span class="t">IO</span><span class="t">::</span><span class="t">Memory</span>.<span class="k">new</span>
<span class="t">HTTP</span><span class="t">::</span><span class="t">FormData</span>.build(io, <span class="s">&#34;boundary&#34;</span>) <span class="k">do</span> <span class="o">|</span>builder<span class="o">|</span>
  builder.field(<span class="s">&#34;foo&#34;</span>, <span class="s">&#34;bar&#34;</span>)
<span class="k">end</span>
io.to_s <span class="c"># =&gt; &#34;--boundary\r\nContent-Disposition: form-data; name=\&#34;foo\&#34;\r\n\r\nbar\r\n--boundary--&#34;</span></code></pre>

<p>See: <code><a href="../HTTP/FormData/Builder.html">FormData::Builder</a></code></p>
</div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata.cr#L182" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="parse(io,boundary,&amp;block)-class-method">
      <a class="dashingAutolink" name="autolink-2221"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20self.parse%28io%2C%20boundary%2C%20%26block%29"></a><div class="signature">
        
        def self.<strong>parse</strong>(io, boundary, &amp;block)

        
      </div>
      
        <div class="doc">
<p>Parses a multipart/form-data message, yielding a <code><a href="../HTTP/FormData/Parser.html">FormData::Parser</a></code>.</p>

<pre><code>form_data <span class="o">=</span> <span class="s">&#34;--aA40\r\nContent-Disposition: form-data; name=\&#34;field1\&#34;\r\n\r\nfield data\r\n--aA40--&#34;</span>
<span class="t">HTTP</span><span class="t">::</span><span class="t">FormData</span>.parse(<span class="t">IO</span><span class="t">::</span><span class="t">Memory</span>.<span class="k">new</span>(form_data), <span class="s">&#34;aA40&#34;</span>) <span class="k">do</span> <span class="o">|</span>part<span class="o">|</span>
  part.name             <span class="c"># =&gt; &#34;field1&#34;</span>
  part.body.gets_to_end <span class="c"># =&gt; &#34;field data&#34;</span>
<span class="k">end</span></code></pre>

<p>See: <code><a href="../HTTP/FormData/Parser.html">FormData::Parser</a></code></p>
</div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata.cr#L90" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="parse(request:HTTP::Request,&amp;block)-class-method">
      <a class="dashingAutolink" name="autolink-2222"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20self.parse%28request%20%3A%20HTTP%3A%3ARequest%2C%20%26block%29"></a><div class="signature">
        
        def self.<strong>parse</strong>(request : <a href="../HTTP/Request.html">HTTP::Request</a>, &amp;block)

        
      </div>
      
        <div class="doc">
<p>Parses a multipart/form-data message, yielding a <code><a href="../HTTP/FormData/Parser.html">FormData::Parser</a></code>.</p>

<pre><code>headers <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Headers</span>{<span class="s">&#34;Content-Type&#34;</span> =&gt; <span class="s">&#34;multipart/form-data; boundary=aA40&#34;</span>}
body <span class="o">=</span> <span class="s">&#34;--aA40\r\nContent-Disposition: form-data; name=\&#34;field1\&#34;\r\n\r\nfield data\r\n--aA40--&#34;</span>
request <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Request</span>.<span class="k">new</span>(<span class="s">&#34;POST&#34;</span>, <span class="s">&#34;/&#34;</span>, headers, body)

<span class="t">HTTP</span><span class="t">::</span><span class="t">FormData</span>.parse(request) <span class="k">do</span> <span class="o">|</span>part<span class="o">|</span>
  part.name             <span class="c"># =&gt; &#34;field1&#34;</span>
  part.body.gets_to_end <span class="c"># =&gt; &#34;field data&#34;</span>
<span class="k">end</span></code></pre>

<p>See: <code><a href="../HTTP/FormData/Parser.html">FormData::Parser</a></code></p>
</div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata.cr#L111" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="parse_content_disposition(content_disposition):Tuple(String,FileMetadata)-class-method">
      <a class="dashingAutolink" name="autolink-2223"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20self.parse_content_disposition%28content_disposition%29%20%3A%20Tuple%28String%2C%20FileMetadata%29"></a><div class="signature">
        
        def self.<strong>parse_content_disposition</strong>(content_disposition) : <a href="../Tuple.html">Tuple</a>(<a href="../String.html">String</a>, <a href="../HTTP/FormData/FileMetadata.html">FileMetadata</a>)

        
      </div>
      
        <div class="doc"><p>Parses a <code>Content-Disposition</code> header string into a field name and
<code><a href="../HTTP/FormData/FileMetadata.html">FileMetadata</a></code>. Please note that the <code>Content-Disposition</code> header for
<code>multipart/form-data</code> is not compatible with the original definition in
<a href="https://tools.ietf.org/html/rfc2183" target="_blank">RFC 2183</a>, but are instead specified
in <a href="https://tools.ietf.org/html/rfc2388" target="_blank">RFC 2388</a>.</p></div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/3c6c75e68f326bb91be35f71ae30672fd454776e/src/http/formdata.cr#L126" target="_blank">View source</a>]
        
      </div>
    </div>
  






</div>



</body></html>