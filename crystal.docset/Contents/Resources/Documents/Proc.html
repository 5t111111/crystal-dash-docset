<!DOCTYPE html><html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta charset="utf-8"/>
  <meta id="repository-name" content="github.com/crystal-lang/crystal"/>
  <link href="css/style.css" rel="stylesheet" type="text/css"/>
  
  <a class="dashingAutolink" name="autolink-3958"></a><a class="dashAnchor" name="//apple_ref/cpp/Class/Proc%28T%2A%29%20-%20github.com%2Fcrystal-lang%2Fcrystal"></a><title>Proc(T*) - github.com/crystal-lang/crystal</title>
</head>
<body>



<div id="main-content">
<h1 class="type-name">

  <span class="kind">struct</span> Proc(T*)

</h1>


  <ul class="superclass-hierarchy">
<li class="superclass"><a href="Proc.html">Proc(T*)</a></li>
<li class="superclass"><a href="Value.html">Value</a></li>
<li class="superclass"><a href="Object.html">Object</a></li>
</ul>




  <h2>Overview</h2>

  <p>A Proc represents a function pointer with an optional context (the closure data). It is typically created with a proc literal:</p>

<pre><code><span class="c"># A proc without arguments</span>
-&gt;{ <span class="n">1</span> } <span class="c"># Proc(Int32)</span>

<span class="c"># A proc with one argument</span>
-&gt;(x : <span class="t">Int32</span>) { x.to_s } <span class="c"># Proc(Int32, String)</span>

<span class="c"># A proc with two arguments:</span>
-&gt;(x : <span class="t">Int32</span>, y : <span class="t">Int32</span>) { x <span class="o">+</span> y } <span class="c"># Proc(Int32, Int32, Int32)</span></code></pre>

<p>The types of the arguments are mandatory, except when directly sending a proc literal to a lib fun in C bindings.</p>

<p>The return type is inferred from the proc&#39;s body.</p>

<p>A special new method is provided too:</p>

<pre><code><span class="t">Proc</span>(<span class="t">Int32</span>, <span class="t">String</span>).<span class="k">new</span> { <span class="o">|</span>x<span class="o">|</span> x.to_s } <span class="c"># Proc(Int32, String)</span></code></pre>

<p>This form allows you to specify the return type and to check it against the proc&#39;s body.</p>

<p>Another way to create a Proc is by capturing a block:</p>

<pre><code><span class="k">def</span> <span class="m">capture</span>(<span class="o">&amp;</span>block : <span class="t">Int32</span> -&gt; <span class="t">Int32</span>)
  <span class="c"># block argument is used, so block is turned into a Proc</span>
  block
<span class="k">end</span>

proc <span class="o">=</span> capture { <span class="o">|</span>x<span class="o">|</span> x <span class="o">+</span> <span class="n">1</span> } <span class="c"># Proc(Int32, Int32)</span>
proc.call(<span class="n">1</span>)                 <span class="c"># =&gt; 2</span></code></pre>

<p>When capturing blocks, the type of the arguments and return type must be specified in the capturing
method block signature.</p>

<h3>Passing a Proc to a C function</h3>

<p>Passing a Proc to a C function, for example as a callback, is possible as long as the Proc isn&#39;t a closure. If it is, either
a compile-time or runtime error will happen depending on whether the compiler can check this. The reason
is that a Proc is internally represented as two void pointers, one having the function
pointer and another the closure data. If just the function pointer is passed, the closure data will be missing
at invocation time.</p>

<p>Most of the time a C function that allows setting a callback also provide an argument for custom data. This custom data
is then sent as an argument to the callback. For example, suppose a C function that invokes a callback at every tick,
passing that tick:</p>

<pre><code><span class="k">lib</span> <span class="t">LibTicker</span>
  <span class="k">fun</span> on_tick(callback : (<span class="t">Int32</span>, <span class="t">Void</span><span class="o">*</span> -&gt;), data : <span class="t">Void</span><span class="o">*</span>)
<span class="k">end</span></code></pre>

<p>To properly define a wrapper for this function we must send the Proc as the callback data, and then
convert that callback data to the Proc and finally invoke it.</p>

<pre><code><span class="k">module</span> <span class="t">Ticker</span>
  <span class="c"># The callback for the user doesn&#39;t have a Void*</span>
  <span class="k">def</span> <span class="m">self</span>.on_tick(<span class="o">&amp;</span>callback : <span class="t">Int32</span> -&gt;)
    <span class="c"># We must save this in Crystal-land so the GC doesn&#39;t collect it (*)</span>
    @@callback <span class="o">=</span> callback

    <span class="c"># Since Proc is a {Void*, Void*}, we can&#39;t turn that into a Void*, so we</span>
    <span class="c"># &#34;box&#34; it: we allocate memory and store the Proc there</span>
    boxed_data <span class="o">=</span> <span class="t">Box</span>.box(callback)

    <span class="c"># We pass a callback that doesn&#39;t form a closure, and pass the boxed_data as</span>
    <span class="c"># the callback data</span>
    <span class="t">LibTicker</span>.on_tick(-&gt;(tick, data) {
      <span class="c"># Now we turn data back into the Proc, using Box.unbox</span>
      data_as_callback <span class="o">=</span> <span class="t">Box</span>(<span class="k">typeof</span>(callback)).unbox(data)
      <span class="c"># And finally invoke the user&#39;s callback</span>
      data_as_callback.call(tick)
    }, boxed_data)
  <span class="k">end</span>
<span class="k">end</span>

<span class="t">Ticker</span>.on_tick <span class="k">do</span> <span class="o">|</span>tick<span class="o">|</span>
  puts tick
<span class="k">end</span></code></pre>

<p>Note that we save the callback in <code>@@callback</code>. The reason is that if we don&#39;t do it, and our code doesn&#39;t
reference it anymore, the GC will collect it. The C library will of course store the callback, but Crystal&#39;s
GC has no way of knowing that.</p>














  <h2>Defined in:</h2>
  
    
      <a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr" target="_blank">proc.cr</a>
    
    <br/>
  





  <h2>Class Method Summary</h2>
  <ul class="list-summary">
    
      <li class="entry-summary">
        <a href="#new%28pointer%3APointer%28Void%29%2Cclosure_data%3APointer%28Void%29%29-class-method" class="signature"><strong>.new</strong>(pointer : Pointer(Void), closure_data : Pointer(Void))</a>
        
      </li>
    
  </ul>



  <h2>Instance Method Summary</h2>
  <ul class="list-summary">
    
      <li class="entry-summary">
        <a href="#%3D%3D%28other%3Aself%29-instance-method" class="signature"><strong>#==</strong>(other : self)</a>
        
      </li>
    
      <li class="entry-summary">
        <a href="#%3D%3D%3D%28other%3Aself%29-instance-method" class="signature"><strong>#===</strong>(other : self)</a>
        
      </li>
    
      <li class="entry-summary">
        <a href="#%3D%3D%3D%28other%29-instance-method" class="signature"><strong>#===</strong>(other)</a>
        
      </li>
    
      <li class="entry-summary">
        <a href="#closure%3F-instance-method" class="signature"><strong>#closure?</strong></a>
        
      </li>
    
      <li class="entry-summary">
        <a href="#closure_data-instance-method" class="signature"><strong>#closure_data</strong></a>
        
      </li>
    
      <li class="entry-summary">
        <a href="#hash-instance-method" class="signature"><strong>#hash</strong></a>
        
      </li>
    
      <li class="entry-summary">
        <a href="#pointer-instance-method" class="signature"><strong>#pointer</strong></a>
        
      </li>
    
      <li class="entry-summary">
        <a href="#to_s%28io%29-instance-method" class="signature"><strong>#to_s</strong>(io)</a>
        
      </li>
    
  </ul>





<div class="methods-inherited">
  
    

  <h3>Instance methods inherited from struct <code><a href="Value.html">Value</a></code>
</h3>
  
    <a href="Value.html#%3D%3D%28other%29-instance-method" class="tooltip">
      <span>==(other)</span>
    ==</a>
  


    


  
    

  <h3>Instance methods inherited from class <code><a href="Object.html">Object</a></code>
</h3>
  
    <a href="Object.html#%21%3D%28other%29-instance-method" class="tooltip">
      <span>!=(other)</span>
    !=</a>, 
  
    <a href="Object.html#%21~%28other%29-instance-method" class="tooltip">
      <span>!~(other)</span>
    !~</a>, 
  
    <a href="Object.html#%3D%3D%28other%29-instance-method" class="tooltip">
      <span>==(other)</span>
    ==</a>, 
  
    <a href="Object.html#%3D%3D%3D%28other%29-instance-method" class="tooltip">
      <span>===(other)<br/>===(other : YAML::Any)<br/>===(other : JSON::Any)</span>
    ===</a>, 
  
    <a href="Object.html#%3D~%28other%29-instance-method" class="tooltip">
      <span>=~(other)</span>
    =~</a>, 
  
    <a href="Object.html#class-instance-method" class="tooltip">
      <span>class</span>
    class</a>, 
  
    <a href="Object.html#clone-instance-method" class="tooltip">
      <span>clone</span>
    clone</a>, 
  
    <a href="Object.html#crystal_type_id-instance-method" class="tooltip">
      <span>crystal_type_id</span>
    crystal_type_id</a>, 
  
    <a href="Object.html#dup-instance-method" class="tooltip">
      <span>dup</span>
    dup</a>, 
  
    <a href="Object.html#hash-instance-method" class="tooltip">
      <span>hash</span>
    hash</a>, 
  
    <a href="Object.html#inspect-instance-method" class="tooltip">
      <span>inspect<br/>inspect(io : IO)</span>
    inspect</a>, 
  
    <a href="Object.html#itself-instance-method" class="tooltip">
      <span>itself</span>
    itself</a>, 
  
    <a href="Object.html#not_nil%21-instance-method" class="tooltip">
      <span>not_nil!</span>
    not_nil!</a>, 
  
    <a href="Object.html#tap%28%26block%29-instance-method" class="tooltip">
      <span>tap(&amp;block)</span>
    tap</a>, 
  
    <a href="Object.html#to_json-instance-method" class="tooltip">
      <span>to_json</span>
    to_json</a>, 
  
    <a href="Object.html#to_pretty_json%28io%3AIO%29-instance-method" class="tooltip">
      <span>to_pretty_json(io : IO)<br/>to_pretty_json</span>
    to_pretty_json</a>, 
  
    <a href="Object.html#to_s-instance-method" class="tooltip">
      <span>to_s<br/>to_s(io : IO)</span>
    to_s</a>, 
  
    <a href="Object.html#to_yaml%28io%3AIO%29-instance-method" class="tooltip">
      <span>to_yaml(io : IO)<br/>to_yaml</span>
    to_yaml</a>, 
  
    <a href="Object.html#try%28%26block%29-instance-method" class="tooltip">
      <span>try(&amp;block)</span>
    try</a>
  


    

  <h3>Class methods inherited from class <code><a href="Object.html">Object</a></code>
</h3>
  
    <a href="Object.html#%3D%3D%28other%3AClass%29-class-method" class="tooltip">
      <span>==(other : Class)</span>
    ==</a>, 
  
    <a href="Object.html#%3D%3D%3D%28other%29-class-method" class="tooltip">
      <span>===(other)</span>
    ===</a>, 
  
    <a href="Object.html#cast%28other%29%3Aself-class-method" class="tooltip">
      <span>cast(other) : self</span>
    cast</a>, 
  
    <a href="Object.html#from_json%28string_or_io%29%3Aself-class-method" class="tooltip">
      <span>from_json(string_or_io) : self</span>
    from_json</a>, 
  
    <a href="Object.html#from_yaml%28string%3AString%29%3Aself-class-method" class="tooltip">
      <span>from_yaml(string : String) : self</span>
    from_yaml</a>, 
  
    <a href="Object.html#hash-class-method" class="tooltip">
      <span>hash</span>
    hash</a>, 
  
    <a href="Object.html#inspect%28io%29-class-method" class="tooltip">
      <span>inspect(io)</span>
    inspect</a>, 
  
    <a href="Object.html#name%3AString-class-method" class="tooltip">
      <span>name : String</span>
    name</a>, 
  
    <a href="Object.html#to_s%28io%29-class-method" class="tooltip">
      <span>to_s(io)</span>
    to_s</a>, 
  
    <a href="Object.html#%7C%28other%3AU.class%29-class-method" class="tooltip">
      <span>|(other : U.class)</span>
    |</a>
  


  
</div>


  <h2>Class Method Detail</h2>
  
    <div class="entry-detail" id="new(pointer:Pointer(Void),closure_data:Pointer(Void))-class-method">
      <a class="dashingAutolink" name="autolink-3949"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20self.new%28pointer%20%3A%20Pointer%28Void%29%2C%20closure_data%20%3A%20Pointer%28Void%29%29"></a><div class="signature">
        
        def self.<strong>new</strong>(pointer : <a href="Pointer.html">Pointer</a>(Void), closure_data : <a href="Pointer.html">Pointer</a>(Void))

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L92" target="_blank">View source</a>]
        
      </div>
    </div>
  



  <h2>Instance Method Detail</h2>
  
    <div class="entry-detail" id="==(other:self)-instance-method">
      <a class="dashingAutolink" name="autolink-3950"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20%3D%3D%28other%20%3A%20self%29"></a><div class="signature">
        
        def <strong>==</strong>(other : self)

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L116" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="===(other:self)-instance-method">
      <a class="dashingAutolink" name="autolink-3951"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20%3D%3D%3D%28other%20%3A%20self%29"></a><div class="signature">
        
        def <strong>===</strong>(other : self)

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L120" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="===(other)-instance-method">
      <a class="dashingAutolink" name="autolink-3952"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20%3D%3D%3D%28other%29"></a><div class="signature">
        
        def <strong>===</strong>(other)

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L124" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="closure?-instance-method">
      <a class="dashingAutolink" name="autolink-3953"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20closure%3F"></a><div class="signature">
        
        def <strong>closure?</strong>

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L106" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="closure_data-instance-method">
      <a class="dashingAutolink" name="autolink-3954"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20closure_data"></a><div class="signature">
        
        def <strong>closure_data</strong>

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L102" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="hash-instance-method">
      <a class="dashingAutolink" name="autolink-3955"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20hash"></a><div class="signature">
        
        def <strong>hash</strong>

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L128" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="pointer-instance-method">
      <a class="dashingAutolink" name="autolink-3956"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20pointer"></a><div class="signature">
        
        def <strong>pointer</strong>

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L98" target="_blank">View source</a>]
        
      </div>
    </div>
  
    <div class="entry-detail" id="to_s(io)-instance-method">
      <a class="dashingAutolink" name="autolink-3957"></a><a class="dashAnchor" name="//apple_ref/cpp/Method/def%20to_s%28io%29"></a><div class="signature">
        
        def <strong>to_s</strong>(io)

        
      </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/crystal-lang/crystal/blob/bbf7c350dcb11e8906631fb62ac87fb965b23f4d/src/proc.cr#L132" target="_blank">View source</a>]
        
      </div>
    </div>
  




</div>



</body></html>